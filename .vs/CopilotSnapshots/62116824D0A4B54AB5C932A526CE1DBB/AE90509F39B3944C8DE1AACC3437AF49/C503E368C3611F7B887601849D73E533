# PowerShell wrapper for build-windows.bat
# This handles UNC paths and ensures Python is in PATH

$ErrorActionPreference = "Continue"

# Check for x86-64 Python (not ARM64)
$pythonPaths = @(
    "C:\Users\johnoshea\AppData\Local\Programs\Python\Python312",
    "C:\Program Files\Python312",
    "C:\Python312"
)

$pythonPath = $null
Write-Host "Searching for x86-64 Python installation..." -ForegroundColor Cyan
Write-Host ""

foreach ($path in $pythonPaths) {
    Write-Host "Checking: $path"
    if (Test-Path "$path\python.exe") {
        try {
            $arch = & "$path\python.exe" -c "import platform; print(platform.machine())" 2>&1 | Select-Object -Last 1
            Write-Host "  Found: $arch architecture"
            if ($arch -match "AMD64|x86_64") {
                $pythonPath = $path
                Write-Host "  ✓ Compatible x86-64 Python found!" -ForegroundColor Green
                break
            }
            else {
                Write-Host "  ✗ Not compatible (need x86-64)" -ForegroundColor Yellow
            }
        }
        catch {
            Write-Host "  ✗ Error checking Python version" -ForegroundColor Yellow
        }
    }
    else {
        Write-Host "  Not found"
    }
}
Write-Host ""

if (-not $pythonPath) {
    Write-Host "ERROR: Python 3.12 x86-64 (AMD64) is not installed" -ForegroundColor Red
    Write-Host ""
    Write-Host "You need Python x86-64 (not ARM64) for building on Windows." -ForegroundColor Yellow
    Write-Host ""
    Write-Host "SOLUTION:" -ForegroundColor Cyan
    Write-Host "1. Download Python 3.12 x86-64 installer:" -ForegroundColor White
    Write-Host "   https://www.python.org/ftp/python/3.12.0/python-3.12.0-amd64.exe" -ForegroundColor White
    Write-Host ""
    Write-Host "2. Run the installer and:" -ForegroundColor White
    Write-Host "   - CHECK 'Add Python to PATH'" -ForegroundColor White
    Write-Host "   - Click 'Install Now'" -ForegroundColor White
    Write-Host ""
    Write-Host "3. After installation, run this script again" -ForegroundColor White
    Write-Host ""
    Read-Host "Press Enter to exit"
    exit 1
}

$ErrorActionPreference = "Stop"

Write-Host "Using Python from: $pythonPath" -ForegroundColor Green
& "$pythonPath\python.exe" --version
Write-Host ""

$env:PATH = "$pythonPath;$pythonPath\Scripts;$env:PATH"

# Get current location
$projectPath = $PSScriptRoot
Write-Host "Project path: $projectPath"

# Change to project directory
Set-Location $projectPath

# Run the batch file using PowerShell to handle the UNC path
Write-Host "`nStarting build process..."
Write-Host ""

# Execute build commands directly in PowerShell
Write-Host "====================================" -ForegroundColor Cyan
Write-Host "PhotoFiler Windows Build Script" -ForegroundColor Cyan
Write-Host "====================================" -ForegroundColor Cyan
Write-Host ""

# Use temp directory for venv (not OneDrive)
$venvDir = "C:\Temp\photofiler-venv"
Write-Host "Using virtual environment at: $venvDir"
Write-Host ""

# Clean up old venv if exists
if (Test-Path $venvDir) {
    Write-Host "Cleaning up old virtual environment..."
    Remove-Item -Recurse -Force $venvDir
}

# Create virtual environment
Write-Host "Creating virtual environment..."
& "$pythonPath\python.exe" -m venv $venvDir
if ($LASTEXITCODE -ne 0) {
    Write-Host "ERROR: Failed to create virtual environment" -ForegroundColor Red
    Read-Host "Press Enter to exit"
    exit 1
}
Write-Host "Virtual environment created"
Write-Host ""

# Activate and get python/pip from venv
$venvPython = "$venvDir\Scripts\python.exe"
$venvPip = "$venvDir\Scripts\pip.exe"

# Upgrade pip
Write-Host "Upgrading pip..."
& $venvPip install --upgrade pip --quiet
Write-Host ""

# Install dependencies
Write-Host "Installing dependencies..."
Write-Host "This may take 5-10 minutes (downloading pre-built packages)..."
Write-Host ""

Write-Host "[1/3] Installing numpy (pre-built wheel)..."
& $venvPip install --only-binary :all: "numpy>=1.26.0,<3.0.0"
if ($LASTEXITCODE -ne 0) {
    Write-Host "ERROR: Failed to install numpy pre-built wheel" -ForegroundColor Red
    Write-Host ""
    Write-Host "This usually means:" -ForegroundColor Yellow
    Write-Host "1. No pre-built wheel available" -ForegroundColor Yellow
    Write-Host "2. Python architecture mismatch" -ForegroundColor Yellow
    Write-Host ""
    Read-Host "Press Enter to exit"
    exit 1
}

Write-Host "[2/3] Installing remaining requirements..."
& $venvPip install Pillow opencv-python transformers torch torchvision numpy tqdm --only-binary :all:
if ($LASTEXITCODE -ne 0) {
    Write-Host "WARNING: Some packages failed with --only-binary, retrying without restriction..." -ForegroundColor Yellow
    & $venvPip install Pillow opencv-python transformers torch torchvision numpy tqdm
    if ($LASTEXITCODE -ne 0) {
        Write-Host "ERROR: Failed to install core requirements" -ForegroundColor Red
        Write-Host ""
        Read-Host "Press Enter to exit"
        exit 1
    }
}

Write-Host "[2.5/3] Installing optional HEIC support..."
& $venvPip install pillow-heif
if ($LASTEXITCODE -ne 0) {
    Write-Host "WARNING: pillow-heif installation failed (HEIC support disabled)" -ForegroundColor Yellow
    Write-Host "This is optional - build will continue"
}

Write-Host "[3/3] Installing GUI and build tools..."
& $venvPip install tkinterdnd2 pyinstaller
if ($LASTEXITCODE -ne 0) {
    Write-Host "ERROR: Failed to install tkinterdnd2 and pyinstaller" -ForegroundColor Red
    Write-Host ""
    Read-Host "Press Enter to exit"
    exit 1
}
Write-Host "All dependencies installed!"
Write-Host ""

# Build executable
Write-Host "====================================" -ForegroundColor Cyan
Write-Host "Building Windows executable..." -ForegroundColor Cyan
Write-Host "This will take 5-10 minutes..." -ForegroundColor Cyan
Write-Host "====================================" -ForegroundColor Cyan
Write-Host ""

& $venvPython -m PyInstaller --clean --noconfirm "packaging\pyinstaller_photo_filer.spec"

if ($LASTEXITCODE -ne 0) {
    Write-Host ""
    Write-Host "ERROR: Build failed!" -ForegroundColor Red
    Write-Host "Check the output above for errors."
    Read-Host "Press Enter to exit"
    exit 1
}

Write-Host ""
Write-Host "====================================" -ForegroundColor Green
Write-Host "BUILD COMPLETE!" -ForegroundColor Green
Write-Host "====================================" -ForegroundColor Green
Write-Host ""
Write-Host "Executable created at: dist\PhotoFiler\PhotoFiler.exe"
Write-Host "Size: ~1.3GB (includes AI model)"
Write-Host ""
Write-Host "To test:"
Write-Host "  dist\PhotoFiler\PhotoFiler.exe --help"
Write-Host "  dist\PhotoFiler\PhotoFiler.exe"
Write-Host ""
Write-Host "The executable is standalone and can be copied to any Windows PC."
Write-Host ""

# Clean up temporary venv
Write-Host "Cleaning up temporary files..."
Remove-Item -Recurse -Force $venvDir -ErrorAction SilentlyContinue
Write-Host ""
Write-Host "Cleanup complete!"
Write-Host ""

Read-Host "Press Enter to exit"
