# PowerShell wrapper for build-windows.bat
# This handles UNC paths and ensures Python is in PATH

$ErrorActionPreference = "Stop"

# Set Python path
$pythonPath = "C:\Users\johnoshea\AppData\Local\Programs\Python\Python312-arm64"
$env:PATH = "$pythonPath;$pythonPath\Scripts;$env:PATH"

Write-Host "Using Python from: $pythonPath"
& "$pythonPath\python.exe" --version

# Get current location
$projectPath = $PSScriptRoot
Write-Host "Project path: $projectPath"

# Change to project directory
Set-Location $projectPath

# Run the batch file using PowerShell to handle the UNC path
Write-Host "`nStarting build process..."
Write-Host ""

# Execute build commands directly in PowerShell
Write-Host "====================================" -ForegroundColor Cyan
Write-Host "PhotoFiler Windows Build Script" -ForegroundColor Cyan
Write-Host "====================================" -ForegroundColor Cyan
Write-Host ""

# Use temp directory for venv (not OneDrive)
$venvDir = "C:\Temp\photofiler-venv"
Write-Host "Using virtual environment at: $venvDir"
Write-Host ""

# Clean up old venv if exists
if (Test-Path $venvDir) {
    Write-Host "Cleaning up old virtual environment..."
    Remove-Item -Recurse -Force $venvDir
}

# Create virtual environment
Write-Host "Creating virtual environment..."
& "$pythonPath\python.exe" -m venv $venvDir
if ($LASTEXITCODE -ne 0) {
    Write-Host "ERROR: Failed to create virtual environment" -ForegroundColor Red
    Read-Host "Press Enter to exit"
    exit 1
}
Write-Host "Virtual environment created"
Write-Host ""

# Activate and get python/pip from venv
$venvPython = "$venvDir\Scripts\python.exe"
$venvPip = "$venvDir\Scripts\pip.exe"

# Upgrade pip
Write-Host "Upgrading pip..."
& $venvPip install --upgrade pip --quiet
Write-Host ""

# Install dependencies
Write-Host "Installing dependencies..."
Write-Host "This may take 5-10 minutes (downloading pre-built packages)..."
Write-Host ""

Write-Host "[1/3] Installing numpy (pre-built wheel)..."
& $venvPip install --only-binary :all: "numpy>=1.26.0,<3.0.0" --quiet
if ($LASTEXITCODE -ne 0) {
    Write-Host "ERROR: Failed to install numpy pre-built wheel" -ForegroundColor Red
    Write-Host ""
    Write-Host "This usually means:" -ForegroundColor Yellow
    Write-Host "1. No pre-built wheel available for Python 3.13 yet" -ForegroundColor Yellow
    Write-Host "2. Try Python 3.12 instead: https://www.python.org/downloads/release/python-3120/" -ForegroundColor Yellow
    Write-Host ""
    Read-Host "Press Enter to exit"
    exit 1
}

Write-Host "[2/3] Installing remaining requirements..."
& $venvPip install Pillow opencv-python transformers torch torchvision numpy tqdm --only-binary :all: --quiet
if ($LASTEXITCODE -ne 0) {
    Write-Host "WARNING: Some packages failed with --only-binary, retrying without restriction..." -ForegroundColor Yellow
    & $venvPip install Pillow opencv-python transformers torch torchvision numpy tqdm --quiet
    if ($LASTEXITCODE -ne 0) {
        Write-Host "ERROR: Failed to install core requirements" -ForegroundColor Red
        Write-Host ""
        Write-Host "Make sure you have x86-64 Python installed (not ARM64)" -ForegroundColor Yellow
        Write-Host ""
        Read-Host "Press Enter to exit"
        exit 1
    }
}

Write-Host "[2.5/3] Installing optional HEIC support..."
& $venvPip install pillow-heif --quiet
if ($LASTEXITCODE -ne 0) {
    Write-Host "WARNING: pillow-heif installation failed (HEIC support disabled)" -ForegroundColor Yellow
    Write-Host "This is optional - build will continue"
}

Write-Host "[3/3] Installing GUI and build tools..."
& $venvPip install tkinterdnd2 pyinstaller --quiet
if ($LASTEXITCODE -ne 0) {
    Write-Host "ERROR: Failed to install tkinterdnd2 and pyinstaller" -ForegroundColor Red
    Write-Host ""
    Read-Host "Press Enter to exit"
    exit 1
}
Write-Host "All dependencies installed!"
Write-Host ""

# Build executable
Write-Host "====================================" -ForegroundColor Cyan
Write-Host "Building Windows executable..." -ForegroundColor Cyan
Write-Host "This will take 5-10 minutes..." -ForegroundColor Cyan
Write-Host "====================================" -ForegroundColor Cyan
Write-Host ""

& $venvPython -m PyInstaller --clean --noconfirm "packaging\pyinstaller_photo_filer.spec"

if ($LASTEXITCODE -ne 0) {
    Write-Host ""
    Write-Host "ERROR: Build failed!" -ForegroundColor Red
    Write-Host "Check the output above for errors."
    Read-Host "Press Enter to exit"
    exit 1
}

Write-Host ""
Write-Host "====================================" -ForegroundColor Green
Write-Host "BUILD COMPLETE!" -ForegroundColor Green
Write-Host "====================================" -ForegroundColor Green
Write-Host ""
Write-Host "Executable created at: dist\PhotoFiler\PhotoFiler.exe"
Write-Host "Size: ~1.3GB (includes AI model)"
Write-Host ""
Write-Host "To test:"
Write-Host "  dist\PhotoFiler\PhotoFiler.exe --help"
Write-Host "  dist\PhotoFiler\PhotoFiler.exe"
Write-Host ""
Write-Host "The executable is standalone and can be copied to any Windows PC."
Write-Host ""

# Clean up temporary venv
Write-Host "Cleaning up temporary files..."
Remove-Item -Recurse -Force $venvDir -ErrorAction SilentlyContinue
Write-Host ""
Write-Host "Cleanup complete!"
Write-Host ""

Read-Host "Press Enter to exit"
